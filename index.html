<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<title>Grader</title>
	<link rel="stylesheet" href="highlight/styles/default.css">
	<!-- <script src="highlight/highlight.pack.js"></script>
	<script>hljs.initHighlightingOnLoad();</script> -->
	<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Inconsolata:wght@400;700&family=Libre+Franklin:wght@400;700&display=swap" rel="stylesheet">
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<!-- <script src="https://kit.fontawesome.com/25d307a19a.js" crossorigin="anonymous"></script> -->
	<link rel="stylesheet" type="text/css" href="style.css">
	<script src="codemirror-5.65.3/lib/codemirror.js"></script>
	<link rel="stylesheet" href="codemirror-5.65.3/lib/codemirror.css">
	<script src="codemirror-5.65.3/mode/javascript/javascript.js"></script>
	<script src="codemirror-5.65.3/mode/python/python.js"></script>
	<script src="https://cdn.plot.ly/plotly-2.14.0.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js" integrity="sha512-LhccdVNGe2QMEfI3x4DVV3ckMRe36TfydKss6mJpdHjNFiV07dFpS2xzeZedptKZrwxfICJpez09iNioiSZ3hA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>

	<div id="mainContain">

		<!-- <div id="saveDot" v-on:click="save()" v-bind:style="{color: saved ? '#7ea04d' : '#c56183'}">
			<span v-if="saved">Saved</span><span v-else>Unsaved Changes</span> 
			&middot;
		</div> -->

		<!-- <div id="assessmentContain">
			<input id="studentGrade" v-model="selectedStudent.grade" placeholder="grade" />
			
		</div> -->
		
		<div id="mainCols">
			<div id="studentCol">
				<div id="nav">
					<h1>Grader</h1>
					<div style="display: flex; justify-content: space-around; margin-bottom: .5em">
						<button v-on:click="view = 'setup'; drawGradeChart();">Setup</button>
						<button v-on:click="view = 'grade';">Grade</button>
					</div>
					<div style="text-align:center;">
						<button id="saveBtn" v-on:click="save()">
							<span v-if="saving">Saving</span>
							<span v-else>Save</span>
						</button>
						<div style="font-size: .8em">{{lastSaved}}</div>
						<input type="checkbox" id="autoRun" v-model="autoRunMode" tooltip="">
						<input type="checkbox" id="autoRun" v-model="testingSuite">
					</div>
					<!-- <div><button v-on:click="save()">Save</button></div> -->
					<!-- <div style="width: 20%;"></div> -->
				</div>
				<div id="studentColRows">
				<div class="studentColRow" v-for="student in students" v-on:click="selectStudent(student); view = 'grade'" v-bind:class="{selectedStudent: selectedStudent.dir == student.dir}">
					<!-- <span v-if="student.grade !== ''">&checkmark;</span>  -->
					<!-- {{student.dir | truncate(20)}} -->
					{{student.dir.split('_')[anonymize]}} ({{studentGrade(student)}})
				</div>
				</div>
			</div>
			<div id="infoCol" v-if="view == 'grade' && size(rubric) !== 0">
				<div id="fileNav">
					<div v-for="file in selectedStudent.files" v-on:click="selectFile(file)" v-bind:class="{selectedFile: selectedStudent.selectedFile.name == file.name}">{{file.name}}</div>
				</div>
				<div id="fileContain">
					
					<!-- <textarea v-model="pipedInput" style=""></textarea> -->

					<div style="display: flex; margin-bottom: .5em;">

						<div style="resize: horizontal; width: 50%; flex: 1 1 auto;" v-show="selectedStudent.selectedFile.type === 'py'"><textarea id="scriptEditor"></textarea></div>
						
						<div class="htmlPreview" v-if="selectedStudent.selectedFile.type !== 'py'" v-html="selectedStudent.selectedFile.html" style="width: 100%"></div>
						<!-- <div class="handler"></div> -->
						<div v-show="selectedStudent.selectedFile.type === 'py'" style="width: 50%; flex: 1 1 auto;">
<!-- 						<pre id="terminal">
PROGRAM OUTPUT
{{terminal}}</pre> -->
						<pre id="terminal" v-html="terminal"></pre>
						<div id="scriptOptions">
							<input id="pipedInput" placeholder="piped input seperated by commas" v-model="fileInput" style="width: 100%;" v-on:keyup.enter="runEditedScript();"/>
<!-- 							<button v-on:click="runEditedScript()">Run Script with Piped Input</button>
 -->							
							<textarea id="additionalCode" placeholder="additional code to append to file" v-model="additionalCode" style="width: 100%"></textarea>
							<textarea id="scratchPad" placeholder="scratch pad" v-model="scratchPad" style="width: 100%; resize: vertical"></textarea>
							<button v-on:click="runEditedScript()">Run Script</button> <button v-on:click="openTerminalAtDir()">Open Terminal</button>
							<!-- <button v-on:click="runMode = runMode == 'original' ? 'edited' : 'original'">Toggle Editor</button>
							<input type="checkbox" id="autoRun" v-model="autoRunMode">
							<label for="autoRun">Auto Run w/ Add. Code</label> -->
						</div>
						</div>

						
					</div>
					
					
					<!-- <textarea v-model="selectedStudent.selectedFile.raw" id="selectedFileContain"></textarea> -->

					<!-- <div v-if="runMode == 'original'">
						<div v-if="selectedStudent.selectedFile.graderHtml" v-html="selectedStudent.selectedFile.graderHtml"></div>
						<div v-if="selectedStudent.selectedFile.html" v-html="selectedStudent.selectedFile.html"></div>
					</div> -->
					<!-- <div v-else> -->
						<!-- <button v-on:click="runEditedScript()">Run Edited Script</button> -->
						
					<!-- </div> -->

					
					

					
					

					<!-- <input id="runCommand" v-model="runCommand" style="width: 70%"/> <button v-on:click="copyRunCommand()">Copy</button>&nbsp; -->

				</div>
			</div>

			<!-- GRADE COL -->
			<div id="gradeCol" v-if="view == 'grade'">
				<select id="rubricCatSelector" v-model="selectedRubricCatID" @change="selectedRubricCat = rubric[selectedRubricCatID]">
					<option v-for="(cat,cid) in rubric" v-bind:value="cid">
						{{ cat.name }} ({{cat.points}})
					</option>
				</select>

				<div id="rubricCatProgressBar">
					<div class="back"></div>
					<div class="front" v-bind:style="{width: (rubricCatProgress(selectedRubricCat)/students.length)*100+'%'}"></div>
				</div>
				<div id="textProgress">{{rubricCatProgress(selectedRubricCat)}} of {{students.length}} graded</div>

				<div style="margin-bottom: 1.6em; font-weight: bold;">
					{{selectedStudent.rubric[selectedRubricCatID].points}}<!-- /{{selectedRubricCat.points}} points -->
				</div>

				<div class="rubricItem" v-for="(item, itemID, index) in selectedRubricCat.items">
					<div class="rubricItemIndex" v-bind:class="{selected: selectedStudent.rubric[selectedRubricCatID].items.indexOf(itemID) !== -1}">{{(index+1)}}</div>
					<div>
						<input class="rubricItemPoints" v-model="item.points">
						<textarea class="rubricItemDesc" v-model="item.desc"></textarea>
					</div>
				</div>
				<div class="rubricItem">
					<div class="rubricItemIndex">{{(Object.keys(selectedRubricCat.items).length+1)}}</div>
					<div>
						<input class="rubricItemPoints" v-model="newRubricItem.points" placeholder="pts">
						<textarea class="rubricItemDesc" v-model="newRubricItem.desc" placeholder="description" v-on:keyup.enter="addRubricItem(selectedRubricCat)"></textarea>
					</div>
				</div>

				<textarea id="studentCatComments" v-model="selectedStudent.rubric[selectedRubricCatID].comments" placeholder="problem specific comments"></textarea>

				<p style="font-size: .7em;">Adjustment: <input style="width: 20%;" v-model="selectedStudent.gradeAdjustment"></p>
				<textarea id="studentComments" v-model="selectedStudent.comments" placeholder="additional or general comments"></textarea>

				<select v-model="easyFeedback" @change="selectedStudent.comments += easyFeedback">
					<option v-for="comment in studentComments" v-bind:value="comment">
						{{comment}}
					</option>
				</select>

				<div>Total Grade: {{studentGrade(selectedStudent)}}/{{highestPossibleGrade()}}</div>
			</div>

			<!-- SETUP -->
			<div id="setupCol" v-if="view == 'setup'">

				<h2>Setup</h2>

				<!-- Course: <select v-model="selectedCourseName">
					<option v-for="option in courses" v-bind:value="option">{{option.name}}</option>
				</select> -->

				<div style="display: flex;">
					<button v-for="course in courses" style="margin-right: 1em" v-bind:class="{'selectedBtn': selectedCourse.name == course.name}" v-on:click="selectedCourse = course; loadHWDirs();">{{course.name}}</button>
					<!-- <button v-on:click="showAddCourse = !showAddCourse">Add New Course</button> -->
				</div>

				<div style="display: flex; margin-top: 1em">
					<button v-for="dir in hwDirs" style="margin-right: 1em" v-bind:class="{'selectedBtn': hwDir == dir.name}" v-on:click="hwDir = dir.name; loadStudentData()">{{dir.name}}</button>
				</div>

				
				<div v-if="showAddCourse">
					<input v-model="newCourse.name" placeholder="Course Name">
					<input v-model="newCourse.dir" placeholder="Directory">
					<button v-on:click="addNewCourse()">Add</button>
				</div>

				<!-- <h3>Files and Directories</h3>
				<p>Course Name: <input v-model="selectedCourse.name" style="width: 50%;" /></p>
				<p>Course Directory: <input v-model="selectedCourse.dir" style="width: 50%;" /></p>
				<p>HW Directory: <input v-model="hwDir" style="width: 20%;" />
					<button v-on:click="updateLS()">Save</button>
				</p> -->
<!-- 				<p>
					Path to Email Addresses: <input v-model="emailAddressPath" style="width: 80%;" />
				</p> -->
				<!-- <p>Names Need Reformatting: <input type="checkbox" v-model="namesNeedReformatting"></p> -->
				<p>
					<button v-on:click="reload()">Reload</button>
					<button v-on:click="copyCommonFiles()">Copy Common Files</button>
					<button v-on:click="runGrader()">Run grader.py</button>
					<button v-on:click="makeGradeWorksheet()">Make Grade Worksheet</button>
					<button v-on:click="anonymize = anonymize == 0 ? 1 : 0">Toggle Anonymity</button>
				</p>

				

				<h3>Rubric</h3>
				<div style="display: flex">
					<div style="width: 50%">
						<div v-for="(cat, cid) in rubric" style="margin-bottom: .5em">
							<input v-model="cat.name"> <input v-model="cat.points">
						</div>
						<div>
							<input id="newRubricCategoryInp" placeholder="New Rubric Category" v-model="newRubricCat.name"> <input placeholder="pts" v-model="newRubricCat.points" type="number" v-on:keyup.enter="addRubricCat()">
						</div>
					</div>
					<div id="gradeChart" style="width:50%;height:400px;"></div>

				</div>


				<h3>Student Overview</h3>
				<table id="studentOverview" v-if="size(rubric) !== 0">
					<tr>
						<th>Student</th>
						<th v-for="(cat, cid) in rubric">{{cat.name}} ({{cat.points}})</th>
						<th>Total ({{highestPossibleGrade()}})</th>
					</tr>
					<tr v-for="student in students">
						<td>{{student.dir.split('_')[0]}}</td>
						<td v-for="(cat, cid) in rubric">{{studentCatGrade(student, cid)}}</td>
						<td>{{studentGrade(student)}}</td>
					</tr>
				</table>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="ansi_up.js"></script>
	<script type="text/javascript">
		
		var dat;

		var ansi_up = new AnsiUp;

		var V = new Vue({
			el: '#mainContain',
			data: {
				cm: null,
				courses: [],
				hwDirs: [],
				selectedCourse: {},
				showAddCourse: false,
				newCourse: {name: '', dir: ''},
				hwDir: 'HW01',
				emailAddressPath: '/Users/ndiana/',
				outputDir: 'output',
				students: [],
				selectedStudent: {
					grade: 'NONE',
					comments: "No student selected",
					files: [],
					dir: "",
					selectedFile: {
						runOriginal: true,
						name: "",
						graderHtml: "",
						html: ""
					},
					rubric: {
						// 'c-dummy': {items: [], points: 0, comments: ""}
					}
				},
				namesNeedReformatting: false,
				runCommand: "",
				fileInputs: {},
				fileInput: "",
				terminal: "",
				additionalCode: "",
				saving: false,
				saved: false,
				lastSaved: '',
				runMode: 'original',
				autoRunMode: true,
				previouslySelectedFile: '',
				view: 'setup',
				rubric: {
					// "c-dummy": {name: "Dummy", points: 0, items: {}}
				},
				newRubricCat: {
					name: "",
					points: ""
				},
				selectedRubricCat: { name: "", items: []},
				selectedRubricCatID: "c-dummy",
				newRubricItem: {
					points: "",
					desc: ""
				},
				easyFeedback: "",
				anonymize: 0,
				scratchPad: "",
				testingSuite: false
			},
			computed: {
				hwPath: function(){
					return V.selectedCourse.dir+'/Grading/'+V.hwDir;
				},
				studentComments: function(){
					if (V == undefined)
						return [];
					return V.students.filter(function(stu){
						return stu.comments !== "";
					}).map(function(stu){
						return stu.comments;
					})
				}
			},
			watch: {
				students: {
					deep: true,
					handler(){
						V.saved = false;
					}
				},
				fileInput: function(newVal, oldVal){
					V.fileInputs[this.selectedStudent.selectedFile.name] = V.fileInput;
				}
			},
			mounted(){
		        this._keyListener = function(e) {
		            if (e.key === "s" && (e.ctrlKey || e.metaKey)) {
		                e.preventDefault(); // present "Save Page" from getting triggered.
		                console.log(e);
		                V.save();
		            }

		            // if (e.key === "Tab") {
	            	// 	e.preventDefault();
	            	// 	if (document.activeElement.id == 'studentGrade'){
	            	// 		document.getElementById('studentComments').focus();
	            	// 	}
	            	// 	else if (document.activeElement.id == 'studentComments'){
	            	// 		document.getElementById('studentGrade').focus();
	            	// 	}
	            	// 	else{
	            	// 		document.getElementById('studentGrade').focus();
	            	// 	}
		            // }

		            var textareas = ['studentCatComments', 'studentComments', 'additionalCode', 'scriptEditor'];
		            var inputBoxes = ['studentGrade', 'pipedInput']

		            // If textarea, return early
		            if (textareas.indexOf(document.activeElement.id) !== -1 || document.activeElement.tagName == 'TEXTAREA'){
		            	if (e.key === "Escape") {
		            		e.preventDefault();
		            		document.activeElement.blur();
			            }
		            	return;
		            }

		            if (e.key === "ArrowUp") {
		                console.log("PREV STUDENT");
		                e.preventDefault();
		                V.prevStudent();
		            }
		            if (e.key === "ArrowDown") {
		                console.log("NEXT STUDENT");
		                e.preventDefault();
		                V.nextStudent();
		            }
		            if (e.key === "]") {
		                console.log("NEXT RUBRIC CATEGORY");
		                e.preventDefault();

		                var match = 0;
		                for (var i = 0; i < Object.keys(V.rubric).length; i++) {
		                	if (Object.keys(V.rubric)[i] == V.selectedRubricCatID)
		                		match = i + 1;
		                }
		                if (match >= Object.keys(V.rubric).length)
		                	match = 0

		                V.selectedRubricCatID = Object.keys(V.rubric)[match]
		                V.selectedRubricCat = V.rubric[V.selectedRubricCatID]
		            }
		            if (e.key === "[") {
		                console.log("PREV RUBRIC CATEGORY");
		                e.preventDefault();

		                var match = 0;
		                for (var i = 0; i < Object.keys(V.rubric).length; i++) {
		                	if (Object.keys(V.rubric)[i] == V.selectedRubricCatID)
		                		match = i - 1;
		                }
		                if (match < 0)
		                	match = Object.keys(V.rubric).length-1;

		                V.selectedRubricCatID = Object.keys(V.rubric)[match]
		                V.selectedRubricCat = V.rubric[V.selectedRubricCatID]
		            }

		            // If inputs, check for up or down, then return
		            // if (inputBoxes.indexOf(document.activeElement.id) !== -1){
		            if (document.activeElement.tagName == "INPUT"){
		            	if (e.key === "Escape") {
		            		e.preventDefault();
		            		document.activeElement.blur();
			            }
		            	return;
		            }

		            if (['1', '2', '3', '4', '5', '6', '7', '8', '9'].indexOf(e.key) !== -1){
		            	e.preventDefault();
		            	var idx = parseInt(e.key)-1;
		            	var idxID = Object.keys(V.selectedRubricCat.items)[idx];
		            	if (idx < Object.keys(V.selectedRubricCat.items).length){
		            		var c = V.selectedStudent.rubric[V.selectedRubricCatID];
		            		if (c.items.indexOf(idxID) !== -1){ // if in list
		            			c.items = _.reject(c.items, function(x){ 
		            				return x ==  idxID
		            			})
		            		}
		            		else{
		            			c.items.push(idxID)
		            		}
		            	}
		            }

		            if (e.key === "ArrowRight") {
		                console.log("NEXT FILE");
		                e.preventDefault();
		                V.nextFile()
		            }
		            if (e.key === "ArrowLeft") {
		                console.log("PREV FILE");
		                e.preventDefault();
		                V.prevFile();
		            }

		            // Up and Down Works for grade, but not for text area


		            
		        };

		        document.addEventListener('keydown', this._keyListener.bind(this));
		    },
			methods: {
				init: function(){

					// var myCodeMirror = CodeMirror(document.body);

					// var lsCourses = localStorage.getItem('courses');
					// if (lsCourses)
					// 	V.courses = JSON.parse(lsCourses);
					// else{
						axios({
							method: 'post',
							url: '/getDirectories',
							data: {
								parent: '/Users/ndiana/Google Drive/Courses'
							}
						}).then(function(resp){
							console.log(resp);
							V.courses = resp.data.map(x => { return {name: x.split('/').pop(), dir: x }});
						});
					//}

					if (V.courses.length > 0){
						var selectedCourseIdx = localStorage.getItem('selectedCourseIdx');
						if (selectedCourseIdx)
							V.selectedCourse = V.courses[selectedCourseIdx];
						else
							V.selectedCourse = V.courses[0];
					}

					var lsHWDir = localStorage.getItem('hwDir');
					if (lsHWDir)
						V.hwDir = lsHWDir;

					// var lsEmails = localStorage.getItem('emailAddressPath');
					// if (lsEmails)
					// 	V.emailAddressPath = lsEmails;

					var lsNamesNeedReformatting = localStorage.getItem('namesNeedReformatting');
					if (lsNamesNeedReformatting && lsNamesNeedReformatting !== null){
						V.namesNeedReformatting = JSON.parse(lsNamesNeedReformatting);
					}

					var lsAdditionalCode = localStorage.getItem('additionalCode');
					if (lsAdditionalCode)
						V.additionalCode = lsAdditionalCode;

					var lsPipedInput = localStorage.getItem('pipedInput');
					if (lsPipedInput)
						V.fileInput = lsPipedInput;

					var lsScratchPad = localStorage.getItem('scratchPad');
					if (lsScratchPad)
						V.scratchPad = lsScratchPad;

					// V.loadStudentData()
				},
				loadHWDirs: function(){
					axios({
						method: 'post',
						url: '/getDirectories',
						data: {
							parent: V.selectedCourse.dir+"/Grading"
						}
					}).then(function(resp){
						console.log(resp);
						V.hwDirs = resp.data.map(x => { return {name: x.split('/').pop(), dir: x }});
					});
				},
				loadStudentData: function(){
					var studentFoldersPath = V.hwPath+'/'+V.outputDir;
					console.log(studentFoldersPath);
					axios({
						method: 'post',
						url: '/loadStudentData',
						data: {
							dir: V.hwPath
						}
					}).then(function(resp){
						console.log(resp);
						if (resp.data !== "" && resp.data.length !== 0){
							console.log("Student Data Found", resp.data)
							V.students = resp.data;
							V.selectStudent(V.students[0]);
							V.loadEmailAddresses();
							V.loadRubricData();
						}
						else{
							console.log("Student Data Not Found")
							V.studentDataFromScratch();

							// intentionally not loading rubric data, so that new 
							// student data can be populated with rubric data
							// potentially need an updateStudentData that would gen rubric
							// for late submissions
						}
					});
				},
				studentDataFromScratch: function(){
					console.log("Building student data from scratch")
					// get all directories in output
					var studentFoldersPath = V.hwPath+'/'+V.outputDir;
					console.log(studentFoldersPath)
					axios({
						method: 'post',
						url: '/ls',
						data: {
							path: studentFoldersPath
						}
					}).then(function(resp){
						var dirs = resp.data;
						console.log(dirs);
						//console.log("A")
						dirs.forEach(function(dir){ // for each dir, create a student
							//console.log("B")
							if (dir[0] !== '.'){
								// console.log("C")
								V.students.push({
									dir: dir,
									// grade: '',
									comments: '',
									gradeAdjustment: 0,
									graded: false
								})
							}
						})

						// V.load();
						//V.autoSave();
						// console.log("D")
						V.selectStudent(V.students[0]);
						// console.log("E")
						V.loadEmailAddresses();
						V.$forceUpdate();
					})
				},
				saveStudentData: function(callback){
					var reducedDat = V.students.map(function(stu){
						return {
							dir: stu.dir,
							comments: stu.comments,
							gradeAdjustment: stu.gradeAdjustment,
							graded: stu.graded,
							rubric: stu.rubric
						}
					})
					axios({
						method: 'post',
						url: '/saveStudentData',
						data: {
							dir: V.hwPath,
							dat: JSON.stringify(reducedDat),
						}
					}).then(function(resp){
						if (callback)
							callback();
					})
				},
				autoSave: function(){
					window.setInterval(function(){
						if (V.saving !== true){
							V.save()
						}
					}, 10000);
					
				},
				loadEmailAddresses: function(){
					axios({
						method: 'post',
						url: '/loadEmailAddresses',
						data: {
							dir: V.selectedCourse.dir+"/Grading"
						}
					}).then(function(resp){
						console.log(resp);
						if (resp.data !== ""){
							console.log("Email Data Found")
							var lar = resp.data.split(/\r?\n/);
							for (var i=1; i<lar.length; i++){
								var line = lar[i].split(',');
								var match = _.find(V.students, function(stu){
									return stu.dir.split("_")[0] == line[0];
								})
								if (match)
									match.emailAddress = line[1]
								else{
									match = _.find(V.students, function(stu){
										return stu.dir.split(" - ")[1] == line[0]
									})
									if (match)
										match.emailAddress = line[1]
									else
										console.log("No email address found for "+line[0]);
								}
							}
						}
						else{
							console.log("Email Data Not Found")
						}
					});
				},
				reformatName: function(name){
					var nar = name.split(' ');
					if (nar.length < 2)
						return undefined;
					var lastName = nar[1].split('_')[0]
					var firstName = nar[0];
					stuName = lastName+firstName.substring(0,2);
					stuName = stuName.toLowerCase();
					return stuName;
				},
				save: function(){
					V.saving = true;
					V.updateLS();
					V.saveStudentData(function(){
						V.saveRubricData(function(){
							V.saving = false;
							const d = new Date();
							let text = d.toTimeString();
							V.lastSaved = text.split(' ')[0]
						});
					})
				},
				load: function(){
					axios({
						method: 'post',
						url: '/load',
						data: {
							dir: V.hwPath
						}
					}).then(function(resp){

						if (resp.data !== ""){
							var lines = resp.data.split('\n');
							console.log(lines)
							var savedStudents = []
							var nextStudent = {comments: []}
							for (var i = 0; i < lines.length; i++) {
								var line = lines[i]
								if (line === "")
									continue;
								if (line[0] === "!"){
									if (nextStudent.dir !== undefined)
										savedStudents.push(nextStudent)

									var lar = line.substring(1).split(" ")
									nextStudent = {comments: []}
									nextStudent.dir = lar[0];
									nextStudent.grade = lar[1];
								}
								else{
									nextStudent.comments.push(line)
								}
							}

							if (nextStudent.dir !== undefined)
								savedStudents.push(nextStudent);

							savedStudents.forEach(function(savedStudent){
								var stu = _.find(V.students, function(student){
									return student.dir == savedStudent.dir || savedStudent.dir === V.reformatName(student.dir)
								})
								stu.grade = savedStudent.grade;
								stu.comments = savedStudent.comments.join('\n\n');
								stu.graded = savedStudent.graded;
							})
						}

						console.log(V.students);

						V.selectStudent(V.students[0]);
					})
				},
				reload: function(){
					V.updateLS();
					location.reload();
				},
				updateLS: function(){
					//localStorage.setItem('courses', JSON.stringify(V.courses))
					//localStorage.setItem('selectedCourse', JSON.stringify(V.selectedCourse))
					//localStorage.setItem('hwPath', V.hwPath);
					//localStorage.setItem('hwDir', V.hwDir);
					localStorage.setItem('namesNeedReformatting', JSON.stringify(V.namesNeedReformatting));
					localStorage.setItem('additionalCode', V.additionalCode);
					localStorage.setItem('pipedInput', V.fileInput);
					localStorage.setItem('scratchPad', V.scratchPad);
					localStorage.setItem('selectedCourseIdx', V.courses.indexOf(V.selectedCourse));
				},
				copyRunCommand: function(){
					document.getElementById('runCommand').select();
					document.execCommand("copy");
				},
				nextStudent: function(){
					var ind = _.findIndex(V.students, function(stu){
						return stu.dir == V.selectedStudent.dir;
					})
					ind += 1;
					if (ind >= V.students.length)
						ind = 0;
					V.selectStudent(V.students[ind])
					setTimeout(function(){
						document.querySelector('.selectedStudent').scrollIntoView({behavior: 'smooth', block: 'nearest', inline: 'start'});
						//document.querySelector('.selectedStudent').scrollIntoView({behavior: 'smooth', block: 'end', inline: 'nearest'});
					}, 100)
					
				},
				prevStudent: function(){
					var ind = _.findIndex(V.students, function(stu){
						return stu.dir == V.selectedStudent.dir;
					})
					ind -= 1;
					if (ind < 0)
						ind = V.students.length-1;
					V.selectStudent(V.students[ind])
					setTimeout(function(){
						document.querySelector('.selectedStudent').scrollIntoView({behavior: 'smooth', block: 'nearest', inline: 'start'});
						//document.querySelector('.selectedStudent').scrollIntoView({behavior: 'smooth', block: 'end', inline: 'nearest'});
					}, 100)
				},
				nextFile: function(){
					var ind = _.findIndex(V.selectedStudent.files, function(file){
						return file.name == V.selectedStudent.selectedFile.name;
					})
					ind += 1;
					if (ind >= V.selectedStudent.files.length)
						ind = 0;
					V.selectFile(V.selectedStudent.files[ind])
				},
				prevFile: function(){
					var ind = _.findIndex(V.selectedStudent.files, function(file){
						return file.name == V.selectedStudent.selectedFile.name;
					})
					ind -= 1;
					if (ind < 0)
						ind = V.selectedStudent.files.length-1;
					V.selectFile(V.selectedStudent.files[ind])
				},
				selectStudent: function(student){
					console.log("SELECTING A STUDENT");
					var stuPath = [V.hwPath, V.outputDir, student.dir].join('/');


					axios({
						method: 'post',
						url: '/lsr',
						data: {
							path: stuPath
						}
					}).then(function(resp){
						console.log(resp);
						var files = resp.data.sort();
						V.processFiles(stuPath, files, student)
					})
				},
				selectFile: function(file){

					console.log(file);
					V.selectedStudent.selectedFile = file;
					V.terminal = "";
					V.runCommand = "python3 "+[this.hwPath, this.outputDir, this.selectedStudent.dir, this.selectedStudent.selectedFile.name].join('/').replace(' ', '\\ ');

					if (V.fileInputs[this.selectedStudent.selectedFile.name] !== undefined){
						V.fileInput = V.fileInputs[this.selectedStudent.selectedFile.name];
					}
					else{
						V.fileInput = ""
					}

					if (this.selectedStudent.selectedFile.raw){
						var ta = document.getElementById('scriptEditor')
						
						if (this.cm !== null)
							this.cm.toTextArea(document.getElementById('scriptEditor'))

						ta.value = this.selectedStudent.selectedFile.raw;

						

						this.cm = CodeMirror.fromTextArea(document.getElementById('scriptEditor'), {
							mode: 'text/plain',
							lineNumbers: true,
							lineWrapping: true
						});

						this.cm.on('change', function(cm) {
							V.selectedStudent.selectedFile.raw = cm.getValue();
						});
					}

					if (this.selectedStudent.selectedFile.name.split('.').pop() == 'py')
						this.cm.setOption('mode', 'python')
						if (V.autoRunMode)
							V.runEditedScript()
						// else
						// 	V.runScript();

					V.previouslySelectedFile = this.selectedStudent.selectedFile.name;

					V.$forceUpdate();
				},
				processFiles: function(studentPath, files, student){
					axios({
						method: 'post',
						url: '/processFiles',
						data: {
							path: studentPath,
							files: files,
						}
					}).then(function(resp){
						console.log(resp);
						var cleaned = []
						resp.data.forEach(function(file){
							if (file.type === 'py'){

								var graderFile = _.find(resp.data, function(needle){
									if (needle.type === 'html')
										return needle.name.indexOf(file.name) !== -1;
									else 
										return false
								})
								if (graderFile !== undefined){
									var el = document.createElement('html');
									el.innerHTML = graderFile.html;
									file.graderHtml = $(el).find('body').html();
								}

								cleaned.push(file);
							}
							if (file.type === 'rtf'){
								var el = document.createElement('html');
								el.innerHTML = file.html;
								file.html = $(el).find('body').html();

								cleaned.push(file);
							}
							if (file.type === 'txt'){
								cleaned.push(file);
							}
							if (file.type === 'html'){
								if (file.name.indexOf('.py') === -1){
									cleaned.push(file);
								}
							}

						})
						console.log(cleaned);
						if (cleaned.length > 0){
							student.files = cleaned;
						}
						else{
							student.files = [{
								name: "noFiles",
								html: "No readable files, check directory. Here are the files we found:<br>"+files.join('<br>')
							}]
						}
						student.selectedFile = student.files[0];
						V.selectedStudent = student;

						// if (V.selectedStudent.rubric == undefined){
						// 	V.selectedStudent.rubric = {'c-dummy': {items: [], points: 0, comments: ""}}
						// 	// V.view = "setup"
						// }

						// try to look at same file you were looking at for the last student
						var match = _.findIndex(V.selectedStudent.files, {name: V.previouslySelectedFile})
						if (match === -1 || V.previouslySelectedFile == '')
							V.selectFile(V.selectedStudent.files[0]);
						else
							V.selectFile(V.selectedStudent.files[match]);

						// V.selectFile(V.selectedStudent.files[0]);
						V.$forceUpdate();
					})
				},
				getHighlightedPythonFiles: function(studentPath, files){
					axios({
						method: 'post',
						url: '/getHighlightedPythonFiles',
						data: {
							path: studentPath,
							files: files,
						}
					}).then(function(resp){
						console.log(resp);
						resp.data.forEach(function(file){
							var el = document.createElement('pre')
							el.innerHTML = file;
							$('#codeCol').append(el);
						})
					})
				},
				getFile: async function(path){
					var result = await axios({
						method: 'post',
						url: '/highlightFile',
						data: {
							path: path
						}
					}).then(function(resp){
						console.log(resp);
						return resp;
					})
				},
				openTerminalAtDir: function(){
					var scriptPath = [this.hwPath, this.outputDir, this.selectedStudent.dir].join('/')
					// var scriptPath = [this.hwPath, this.outputDir, this.selectedStudent.dir, this.selectedStudent.selectedFile.name].join('/')
					//.replace(' ', '\\ ');
					axios({
						method: 'post',
						url: '/openTerminalAtDir',
						data: {
							path: scriptPath,
							input: V.fileInput //.split(',').join('\n')
						}
					}).then(function(resp){

					})
				},
				runScript: function(){
					var scriptPath = [this.hwPath, this.outputDir, this.selectedStudent.dir, this.selectedStudent.selectedFile.name].join('/')//.replace(' ', '\\ ');
					axios({
						method: 'post',
						url: '/runScript',
						data: {
							path: scriptPath,
							input: V.fileInput //.split(',').join('\n')
						}
					}).then(function(resp){
						console.log(resp);
						html = resp.data.join('\n').replace('\\n', '\n');
						html = ansi_up.ansi_to_html(html);
						V.terminal = html
					})
				},
				runScriptWithLine: function(){
					var scriptPath = [this.hwPath, this.outputDir, this.selectedStudent.dir, this.selectedStudent.selectedFile.name].join('/')//.replace(' ', '\\ ');
					axios({
						method: 'post',
						url: '/runScriptWithLine',
						data: {
							path: scriptPath,
							input: V.fileInput.split(',').join('\n'),
							line: V.additionalCode
						}
					}).then(function(resp){
						console.log(resp);
						html = resp.data.join('\n').replace('\\n', '\n');
						html = ansi_up.ansi_to_html(html);
						V.terminal = html
					})
				},
				runEditedScript: function(){
					if (this.selectedStudent.selectedFile.name.indexOf('.txt') !== -1)
						return;
					var scriptPath = [this.hwPath, this.outputDir, this.selectedStudent.dir, this.selectedStudent.selectedFile.name].join('/')//.replace(' ', '\\ ');
					axios({
						method: 'post',
						url: '/runEditedScript',
						data: {
							path: scriptPath,
							input: V.fileInput.split(',').join('\n'),
							code: V.selectedStudent.selectedFile.raw,
							line: V.additionalCode,
							testingSuite: V.testingSuite
						}
					}).then(function(resp){
						console.log(resp);
						html = resp.data.join('\n').replace('\\n', '\n');
						html = ansi_up.ansi_to_html(html);
						V.terminal = html
					})
				},
				makeGradeFile: function(){
					axios({
						method: 'post',
						url: '/makeGradeFile',
						data: {
							path: V.hwPath,
						}
					}).then(function(resp){
						console.log(resp); // TODO Doesn't catch errors.
						alert("Grade File Made!");
					})
				},
				copyCommonFiles: function(){
					axios({
						method: 'post',
						url: '/copyCommonFiles',
						data: {
							path: V.hwPath,
						}
					}).then(function(resp){
						console.log(resp);
					})
				},
				runGrader: function(){
					axios({
						method: 'post',
						url: '/runGraderOnAll',
						data: {
							path: V.hwPath,
						}
					}).then(function(resp){
						console.log(resp);
					})
				},
				// Rubric
				addRubricCat: function(){
					var d = new Date();
					var id =  'c-'+d.getTime();
					var nr = {
						id: id,
						name: V.newRubricCat.name,
						items: {},
						points: V.newRubricCat.points
					}
					nr.items['i-'+d.getTime()] = {points: 0, desc: "Full credit" };

					V.rubric[id] = nr;

					// update student data with new rubric category
					V.students.forEach(function(student){
						if (student.rubric == undefined){
							student.rubric = {}
						}
						student.rubric[id] = {
							items: [],
							comments: ""
						}
					})

					V.newRubricCat.name = "";
					V.newRubricCat.points = "";
					$('#newRubricCategoryInp').focus()
				},
				removeRubricCat: function(catID){
					var c = window.confirm("Are you sure you want to delete this rubric category?")
					if (c){
						delete V.rubric[catID]
						V.students.forEach(function(student){ delete student.rubric[catID]; })
					}
				},
				addRubricItem: function(cat){
					var d = new Date();
					var id = 'i'+d.getTime()
					
					cat.items[id] = { points: V.newRubricItem.points, desc: V.newRubricItem.desc };

					V.newRubricItem.points = ""
					V.newRubricItem.desc = ""
				},
				removeRubricItem: function(cat){

				},
				saveRubricData: function(callback){
					axios({
						method: 'post',
						url: '/saveRubricData',
						data: {
							dir: V.hwPath,
							dat: JSON.stringify(V.rubric),
						}
					}).then(function(resp){
						if (callback)
							callback();
					})
				},
				loadRubricData: function(callback){
					axios({
						method: 'post',
						url: '/loadRubricData',
						data: {
							dir: V.hwPath
						}
					}).then(function(resp){
						console.log(resp)
						if (resp.data !== ""){
							V.rubric = resp.data;
							if (_.size(V.rubric) > 0){
								V.selectedRubricCat = V.rubric[_.keys(V.rubric)[0]] // not great
								V.selectedRubricCatID = _.keys(V.rubric)[0]
							}
						}

						V.autoSave(); // not the best place for this

						if (callback)
							callback();
					})
				},
				studentCatGrade: function(stu, cid){
					var cat = V.rubric[cid];
					var catGrade = parseFloat(cat.points);
					var stuCat = stu.rubric[cid]
					if (stuCat == undefined)
						return "-";
					if (stuCat.items.length == 0)
						return "-"
					stuCat.items.forEach(function(itemID){
						var itemObj = cat.items[itemID]
						catGrade += parseFloat(itemObj.points)
					})
					return catGrade;
				},
				studentGrade: function(student){
					// computing grades
					var grade = 0;
					if (student.rubric === undefined)
						return "-"
					Object.keys(student.rubric).forEach(function(cid){
						var cat = student.rubric[cid]
						var rubObj = V.rubric[cid]
						var catGrade = parseFloat(rubObj.points);

						cat.items.forEach(function(itemID){

							var itemObj = rubObj.items[itemID]
							catGrade += parseFloat(itemObj.points)
						})

						grade += catGrade;
					})
					return grade+parseFloat(student.gradeAdjustment);
				},
				highestPossibleGrade: function(){
					var pts = 0;
					Object.keys(V.rubric).forEach(function(cid){
						pts += parseFloat(V.rubric[cid].points);
					})
					return pts;
				},
				rubricCatProgress: function(cat){
					if (V == undefined)
						return 0;
					return _.filter(V.students, function(stu){
						if (stu.rubric){
							var stuCat = stu.rubric[cat.id]
							if (stuCat && _.size(stuCat.items) > 0)
								return true;
							else
								return false
						}
						else
							return false;
					}).length;
				},
				makeGradeWorksheet: function(callback){
					var dat = [['Identifier', 'Full Name', 'Email Address', 'Grade']] //, 'Feedback']]

					var fob = {}

					var converter = new showdown.Converter();

					V.students.forEach(function(student){

						var dirAr = student.dir.split('_')
						var identifier = dirAr[1];
						var fullName = dirAr[0]
						var nameAr = fullName.split(" ")
						//var emailAddress = nameAr[0][0]+nameAr[nameAr.length-1]+"@colgate.edu";
						var emailAddress = student.emailAddress;

						var autoFeedback = `# Feedback for ${V.hwDir}\n## ${fullName}\n`

						var grade = 0;

						// computing grades
						Object.keys(student.rubric).forEach(function(cid){
							var rubObj = V.rubric[cid]
							var catGrade = parseFloat(rubObj.points);
							var cat = student.rubric[cid];

							if (cat.items.length > 0){
								autoFeedback += `### ${rubObj.name}\n`
							}
							var c = 0;
							cat.items.forEach(function(itemID){

								var itemObj = rubObj.items[itemID]
								catGrade += parseFloat(itemObj.points)
								if (parseFloat(itemObj.points) < 0){
									autoFeedback += `- ${itemObj.points} pts for ${itemObj.desc}\n\n`;
									c += 1
								}
							})

							if (c == 0){
								autoFeedback += `- No points deducted. Good job!\n\n`
							}

							grade += catGrade;

							if (cat.comments && cat.comments !== ""){
								autoFeedback += `<b>Overall feedback for ${rubObj.name}:</b> ${cat.comments}\n\n`;
							}

						})

						grade += parseFloat(student.gradeAdjustment);
						if (student.comments !== "")
							var comments = autoFeedback+"<h3>Additional General Comments:</h3> "+student.comments;
						else
							var comments = autoFeedback;

						var html = converter.makeHtml(comments);
						var style = `body{
							padding: 2em;
						}`
						fob[student.dir] = `<html><style type="text/css">${style}</style><body>${html}<h2>Grade: ${grade}/100</h2></body></html>`;

						dat.push([identifier, fullName, emailAddress, grade]) //, comments])
					})

					console.log(dat);

					// var datString = dat.map(function(x){ return x.join(',') }).join('\n')
					// console.log(datString);
					axios({
						method: 'post',
						url: '/makeGradeWorksheet',
						data: {
							dir: V.hwPath,
							dat: dat,
							fob: fob
						}
					}).then(function(resp){
						console.log(resp);
						if (callback)
							callback();
					})
				},

				addNewCourse: function(){
					V.courses.push({
						name: V.newCourse.name,
						dir: V.newCourse.dir,
					})
					V.newCourse = {name: '', dir: ''}
					localStorage.setItem('courses', JSON.stringify(V.courses))
				},

				drawGradeChart: function(){
					var x = V.students.map(s => { return V.studentGrade(s) })
					var trace = {
					    x: x,
					    type: 'histogram',
					    // xbins: {
					    // 	end: 100,
					    // 	start: 0,
					    // 	size: 10
					    // }
					  };
					var layout = {
						// margin: {t: 10, b: 10, l: 10, r: 10}
					}
					var data = [trace];
					Plotly.newPlot('gradeChart', data, layout);

				},
				fullCredit: function(){
					for (let key in V.selectedStudent.rubric){

					}
				},

				// UTILITIES
				getObjectById: function(ar, id){
					return _.findWhere(ar, {id: id});
				},
				isRubricItemSelected: function(id){
					var cat = _.findWhere(V.selectedStudent.rubric, {id: V.selectedRubricCatID});
					if (cat)
						return cat.items.indexOf(id) !== -1;
					else
						return false;
				},
				size: function(ob){
					return Object.keys(ob).length;
				},
				isEmpty: function(ob){

				}
			}
		});

		Vue.filter('truncate', function (text, stop, clamp) {
		    return text.slice(0, stop) + (stop < text.length ? clamp || '...' : '')
		})

		V.init();

		var getUrlParameter = function getUrlParameter(sParam) {
		    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
		        sURLVariables = sPageURL.split('&'),
		        sParameterName,
		        i;

		    for (i = 0; i < sURLVariables.length; i++) {
		        sParameterName = sURLVariables[i].split('=');

		        if (sParameterName[0] === sParam) {
		            return sParameterName[1] === undefined ? true : sParameterName[1];
		        }
		    }
		};

		function isScrolledIntoView(el) {
		    var rect = el.getBoundingClientRect();
		    var elemTop = rect.top;
		    var elemBottom = rect.bottom;

		    // Only completely visible elements return true:
		    var isVisible = (elemTop >= 0) && (elemBottom <= window.innerHeight);
		    // Partially visible elements return true:
		    //isVisible = elemTop < window.innerHeight && elemBottom >= 0;
		    return isVisible;
		}
				


	</script>
</body>
</html>